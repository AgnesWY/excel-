<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Excel批量处理</title>
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.js"></script>
    <script src="https://cdn.bootcss.com/xlsx/0.11.5/xlsx.core.min.js"></script>
    <!-- <script>
    var xlsxUtils = (function () { var t = { Binary: { fixdata: function (e) { for (var r = "", t = 0, n = 10240; t < e.byteLength / n; ++t)r += String.fromCharCode.apply(null, new Uint8Array(e.slice(t * n, t * n + n))); return r += String.fromCharCode.apply(null, new Uint8Array(e.slice(t * n))) }, s2ab: function (e) { for (var r = new ArrayBuffer(e.length), t = new Uint8Array(r), n = 0; n != e.length; ++n)t[n] = 255 & e.charCodeAt(n); return r } }, _wb: null, _rABS: !1, import: function (e, r) { this.wb = null; var n = new FileReader; n.onload = function (e) { var n = e.target.result; t._wb = t._rABS ? XLSX.read(btoa(t.Binary.fixdata(n)), { type: "base64" }) : XLSX.read(n, { type: "binary" }), "function" == typeof r && r(t._wb) }, t._rABS ? n.readAsArrayBuffer(e) : n.readAsBinaryString(e) }, getSheetByName: function (e) { return XLSX.utils.sheet_to_json(t._wb.Sheets[e]) }, getSheetByIndex: function () { var e = arguments.length > 0 && void 0 !== arguments[0] ? arguments[0] : 0; return t.getSheetByName(t._wb.SheetNames[e]) }, export: function (e, r) { var n = null; for (var o in e) { var a = t.format2Sheet(e[o]); n = t.format2WB(a, o, n) } return t.format2Blob(n, r) }, readDataHead: function (e) { var r = {}, t = Array.isArray(e) ? Object.keys(e[0]) : e, n = !0, o = !1, a = void 0; try { for (var i, f = t[Symbol.iterator](); !(n = (i = f.next()).done); n = !0) { var u = i.value; r[u] = u } } catch (e) { o = !0, a = e } finally { try { !n && f.return && f.return() } finally { if (o) throw a } } return r }, format2Sheet: function (e, r, n, o) { o = o || Object.keys(e[0]), r = r || 0, n = n || 0; var a = {}; return e.map(function (e, a) { return o.map(function (o, i) { return Object.assign({}, { v: e[o], position: (i + r > 25 ? t.getCharCol(i + r) : String.fromCharCode(65 + (i + r))) + (a + 1 + n) }) }) }).reduce(function (e, r) { return e.concat(r) }).forEach(function (e, r) { return a[e.position] = { v: e.v } }), a }, format2WB: function (e, r, t, n) { r = r || "mySheet"; var o = Object.keys(e); return t || (t = { Sheets: {}, SheetNames: [] }), t.SheetNames.push(r), t.Sheets[r] = Object.assign({}, e, { "!ref": n || o[0] + ":" + o[o.length - 1] }), t }, format2Blob: function (e, r) { return new Blob([t.Binary.s2ab(XLSX.write(e, { bookType: void 0 == r ? "xlsx" : r, bookSST: !1, type: "binary" }))], { type: "" }) }, getCharCol: function (e) { for (var r = "", t = 0; e > 0;)t = e % 26 + 1, r = String.fromCharCode(t + 64) + r, e = (e - t) / 26; return r } }; return t })();
    </script> -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.15.1/xlsx.core.min.js"></script> -->
    <!-- <script src="./js/xlsx.full.min.js"></script> -->


</head>
<style>
   
    .wrap{
        margin: 0 auto;
        width : 1000px;
        font-size: 16px;
        font-family: 'PuHuiTi-Regular'
    }
    #excel-file{
        padding: 8px 16px;
        border: solid 1px #ccc;
        cursor: pointer;
        
    }
    .tips{
        font-size:12px;
        padding: 8px 16px;
        background-color: #ecf8ff;
        border-radius: 4px;
        border-left: 5px solid #50bfff;
        margin: 20px 0;

    }
    .exportBtn {
        background: #fff;
        color: #606266;
        padding: 8px 16px;
        border: 1px solid #dcdfe6;
        cursor: pointer;
    }
    .exportBtn:hover {
        color: #409eff;
        background: #ecf5ff;
        border-color: #b3d8ff;

    }
    .exportTip{
        display:none;
        font-size:12px;
        padding: 8px 16px;
        color: #f56c6c;
        background-color: #ecf8ff;
        border-radius: 4px;
        border-left: 5px solid #f56c6c;
        margin: 20px 0;
    }
    #result {
        height: 480px;
        overflow-y: auto;
    }
    #preTable{
        width: 1000px;
        height: 480px;
        overflow: auto;
        display: none;

    }


</style>
<body>
    <div class="wrap">
        <div class="import-part">
            <input type="file" id="excel-file">
            <!-- <input type="file" id="excel-file" style="display: none">
            <a href="javascript:selectFile()">导入模版数据</a> -->
            <p class="tips">考勤规则：（下面表格可直接修改考勤配置，两班倒修改正常上下班时间即可）</p>
            <div id="result" contenteditable>

            </div>
            
        </div>
        <div class="option-part">
            <p class="tips">导出数据：不修改上下班时间配置直接导出，或修改配置后点击导出。【数据异常】的状态：该打卡时间在某天打卡仅有一次且该时间在工作时间。</p>
            <p class="exportTip">提示：请先导入数据哦</p>
            <button id="exportBtn" class="exportBtn" onclick="exportExcel()">导出数据</button>
        </div>
        <div style="display:none;">
            <a id="dlink"></a>
            <table id="preTable">

            </table>

        </div>

    </div>

<!-- <textarea id="area" style="width: 1000px; height:1000px"></textarea> -->

<script>
    var readData = [];
    var optionData = [];
    var transOpt = new Map();
    var departArr = [['行政部','销售内勤','财务部','研发部','  ','总经办','易安特','技服部','平台组','四川消防组','鑫四海','PMC','SMT','采购部','工程部','焊接组','机加车间','库房','模具组','品质部','主机组','注塑车间','装配车间','内勤体系','气体组','市场部'],
                     ['admin','sell','finance','dev','wisdom','manager','yiante','tech','platform','sichuanPro','xinsihai','PMC','SMT','purchase','engineer','weld','machineWorkshop','storeHouse','mould','qa','mainMachine','injectWorkshop','fitWorkshop','service','gas','market']];
    
    //给input标签绑定change事件，一上传选中的.xls文件就会触发该函数
    $('#excel-file').change(function(e) {
        var files = e.target.files;
        var fileReader = new FileReader();
        fileReader.onload = function(ev) {
            try {
                var data = ev.target.result
                var workbook = XLSX.read(data, {
                    type: 'binary'
                }) // 以二进制流方式读取得到整份excel表格对象
                var persons = []; // 存储获取到的数据
            } catch (e) {
                console.log('文件类型不正确');
                return;
            }
            readWorkbook(workbook)
            // 表格的表格范围，可用于判断表头是否数量是否正确
            var fromTo = '';
            // 遍历每张表读取
            for (var sheet in workbook.Sheets) {
                if (workbook.Sheets.hasOwnProperty(sheet)) {
                    fromTo = workbook.Sheets[sheet]['!ref'];
                    persons = persons.concat(XLSX.utils.sheet_to_json(workbook.Sheets[sheet]));
                    break; // 如果只取第一张表
                }
            }

            readData = persons;
            console.log(JSON.stringify(readData))
        };
        // 以二进制方式打开文件
        fileReader.readAsBinaryString(files[0]);
    });
    // 整合数据
    function handleDatas(){
        var dataMap = new Map();
        var tempArr = [];
        $(readData).each(function(index,item){
            // 处理数据
            item.statusFlag = judgeStatus(item.部门, item.签到时间);
            // 合并数据
            if(!dataMap.has(item.帐号)){
                dataMap.set(item.帐号,{
                    '账号':item.帐号,
                    '姓名':item.姓名,
                    '部门':item.部门,
                    dataList:[],
                    

                })
            }
            dataMap.get(item.帐号).dataList.push({
                dailyDate:item.日期,
                flag:item.statusFlag
            });

            

        })
        // 整合横向数据
        tempArr = Array.from(dataMap.values())
        $(tempArr).each(function(index,item){
            var normalCount = 0;
            var lateTimes = 0;
            var leaveTimes = 0;
            var abnormal = 0;
            $(item.dataList).each(function(index,innerItem){

                item[innerItem.dailyDate] = innerItem.flag;
                if(innerItem.flag && innerItem.flag == '正常'){
                    normalCount = normalCount + 1;

                }
                if(innerItem.flag && !(innerItem.flag.indexOf('迟到')< 0)){
                    lateTimes = lateTimes + 1;
                }
                if(innerItem.flag && !(innerItem.flag.indexOf('早退')< 0)){
                    leaveTimes = leaveTimes + 1;

                }
                if(innerItem.flag && !(innerItem.flag.indexOf('数据异常')< 0)){
                    abnormal = abnormal + 1;

                }


            });
            item.出勤天数 = normalCount+lateTimes+leaveTimes+abnormal;
            item.正常天数 = normalCount;
            item.迟到次数 = lateTimes;
            item.早退次数 = leaveTimes;
            item.异常次数 = abnormal;

            delete item.dataList;

        })

        return tempArr
        
        // console.log(tempArr);
    }
    
    // 处理时间
    function splitTime(str){
        var returnTimes =[];
        if(str != "" && str.indexOf("-")>0){
            returnTimes = str.split("-")
        } else{
            if(str != ""){
                returnTimes.push(str);  
            }
        }
        console.log(returnTimes)

        return returnTimes;

    }
    // 判断当前考勤的状态
    function judgeStatus(depart, period){
        var times = splitTime(period);
        if(times.length == 0){
            return '未打卡';
        }else{
            
            // console.log("配置数据："+transOpt);
            var optTimeArr = $.extend(true,[],transOpt.get(depart));
            // var optTimeArr = splitTime(optTime);
            // 针对 两班倒的部门
            if((depart == '机加车间' || depart == '注塑车间') && times.length > 1 && returnCompares(times[0],optTimeArr[1])){
                var newOptArr =  [];
                newOptArr.push(optTimeArr[1]);
                newOptArr.push(optTimeArr[0]);
                
                return compareTimes(newOptArr,times);


            } else{
                return compareTimes(optTimeArr,times);
            }
            

        }



    }
    // 工具-比较两个时间大小  小于等于 返回true
    function returnCompares(time1,time2){
        var timer1 = Date.parse('2018-08-08 '+time1);
        var timer2 = Date.parse('2018-08-08 '+time2);
        return !(time1 > timer2);


    }
    // 比较两个时间大小
    function compareTimes(optTimeArrOrigin,actArrOrigin){
        var optTimeArr = $.extend(true,[],optTimeArrOrigin);
        var actArr = $.extend(true,[],actArrOrigin);
        // 处理日期数据方便比较
        for(var i= 0; i< 2; i++){
            optTimeArr[i] = Date.parse('2018-08-08 '+optTimeArr[i])
            actArr[i] = Date.parse('2018-08-08 '+actArr[i])
        }
        // 打卡时间只有一个
        if(actArrOrigin.length == 1){
            var returnStr = '';
            if(!(actArr[0] > optTimeArr[0])){
              return '下班缺卡'
            }
            if(!(actArr[0] < optTimeArr[1])){
                return '上班缺卡'

            }
            if((actArr[0] > optTimeArr[0]) && (actArr[0] < optTimeArr[1])){
                return '数据异常'+actArrOrigin[0]

            }
        } 
        // 其他
        else{
            
 
            if(!(actArr[0] > optTimeArr[0])&& !(actArr[1] < optTimeArr[1])){
                return "正常"
            }
            if(!(actArr[0] > optTimeArr[0]) && (actArr[1] < optTimeArr[1])){
                var timer = formateMilisecond(optTimeArr[1] - actArr[1])
                return "早退"+timer;

            }
            if((actArr[0] > optTimeArr[0]) && !(actArr[1] < optTimeArr[1])){
                var timer = formateMilisecond(actArr[0]- optTimeArr[0])
                return "迟到"+timer

            }

        }
        

    }


    function  exportExcel(){
        if($("#result").find("table").length>0){
            $(".exportTip").css('display','none');
            saveEdit();
            var newData = handleDatas();
            // 添加table预览
            preDataOnTable(newData);
            var download = tableToExcel();
            download('preTable', '导出table数据', '考勤');

            // var newSheet = XLSX.utils.json_to_sheet(newData);
            // var blob = sheet2blob(newSheet,'考勤汇总');
            // createDownLoadLink(blob,'导出的数据.xlsx');
        } else{
            $(".exportTip").css('display','block');
            $('.exportTip').delay(3000).hide(0);

        }
        

    }
    function saveEdit(){
        var csv = table2csv($('#result table')[0]);
        var data = csv2JSON(csv);
        optionData = JSON.parse(data);
        // 整合配置数据
        transOpt = handleOptions(optionData);
    }
    // 整合配置数据
    function handleOptions(optionData){
        var newMap = new Map();
        // console.log(optionData);
        for(var i=0; i<optionData.length; i++){
            newMap.set(optionData[i].部门,[optionData[i].上班时间,optionData[i].下班时间])

        }
        return newMap;


    }
    // 预览数据
    function preDataOnTable(newData){
        
        // console.log(newData);
        var html = '<tr>';
        var keyArr = Object.keys(newData[0])
        for(var i=0; i<keyArr.length; i++){
            html += '<th>'+keyArr[i]+'</th>'
        }
        html += '</tr>'
        $(newData).each(function(index,item){
            html += '<tr>'
                for(var i=0; i< keyArr.length; i++){
                    
                        if(typeof item[keyArr[i]] =='string' && !(item[keyArr[i]].indexOf('迟到') <0)){
                            html +='<td style="background:#40e491">'+item[keyArr[i]]+'</td>'
                        }
                        else if(typeof item[keyArr[i]] =='string' && !(item[keyArr[i]].indexOf('早退') <0)){
                            html +='<td style="background:#40e491">'+item[keyArr[i]]+'</td>'
                        }
                        else if(typeof item[keyArr[i]] =='string' && !(item[keyArr[i]].indexOf('数据异常') <0)){
                            html +='<td style="background:#e20236">'+item[keyArr[i]]+'</td>'
                        }
                        else if(typeof item[keyArr[i]] =='string' && !(item[keyArr[i]].indexOf('缺卡') <0)){
                            html +='<td style="background:#e49b40">'+item[keyArr[i]]+'</td>'
                        } 
                        else if(typeof item[keyArr[i]] =='string' && !(item[keyArr[i]].indexOf('未打卡') <0)){
                            html +='<td style="background:#e0dcdd">'+item[keyArr[i]]+'</td>'
                        }
                        else if(typeof item[keyArr[i]] =='undefined'){
                            html +='<td style="background:#e0dcdd">未打卡</td>'
                        } 
                        else{
                            html +='<td>'+item[keyArr[i]]+'</td>'
                        }
                   
                   
                }
            html += '</tr>'
                   
        });
        // console.log(html)
        
        $("#preTable").append(html);

        // preTable

    }
    var tableToExcel = (function() {
        var uri = 'data:application/vnd.ms-excel;base64,',
            template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>',
            base64 = function(s) { return window.btoa(unescape(encodeURIComponent(s))) },
            format = function(s, c) { return s.replace(/{(\w+)}/g, function(m, p) { return c[p]; }) };
        return function(table, name, filename) {
            if (!table.nodeType) table = document.getElementById(table);
            // console.log(table.innerHTML)
            var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }//此时的innerHTML数据可以自己自定义 比如json转化 只要值要数据符合即可

            document.getElementById("dlink").href = uri + base64(format(template, ctx));
            document.getElementById("dlink").download = filename;
            document.getElementById("dlink").click();
        }
    });

    function readWorkbook(workbook) {
		var sheetNames = workbook.SheetNames; // 工作表名称集合
		var worksheet = workbook.Sheets[sheetNames[1]]; // 这里我们只读取第二张sheet
		var csv = XLSX.utils.sheet_to_csv(worksheet);
		document.getElementById('result').innerHTML = csv2table(csv);
	}
    // 公用函数
    // 字符串转Buffer
    function s2ab(s) {
        var buf = new ArrayBuffer(s.length);
        var view = new Uint8Array(buf);
        for (var i=0; i!=s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }

    // 将一个sheet对象转化为blob对象
	function sheet2blob(sheet, sheetName) {
		sheetName = sheetName || 'sheet1';
		var workbook = {
			SheetNames: [sheetName],
			Sheets: {}
		};
		workbook.Sheets[sheetName] = sheet;
		// 生成excel的配置项
		var wopts = {
			bookType: 'xlsx', // 要生成的文件类型
			bookSST: false, // 是否生成Shared String Table，官方解释是，如果开启生成速度会下降，但在低版本IOS设备上有更好的兼容性
			type: 'binary'
		};
        // 样式设置
        // for(var item in workbook.Sheets[sheetName]){
        //     workbook.Sheets[sheetName][item].s = {
        //         fill: {
        //             fgColor: {
        //                 rgb: 'a4a3a5'
        //             }
        //         }
        
        //   };
            

        // }
		var wbout = XLSX.write(workbook, wopts);
		var blob = new Blob([s2ab(wbout)], {type:"application/octet-stream"});
		return blob;
	}
    // 利用blob对象生成一个下载链接
    function createDownLoadLink(url, saveName){
        if(typeof url == 'object' && url instanceof Blob){
            url = window.URL.createObjectURL(url)
        }
        // alink
        var aLink = document.createElement('a');
        aLink.href = url;
        aLink.download = saveName || '';

        var event;
        if(window.MouseEvent){
            event = new MouseEvent('click');
        } else {
            event = document.createEvent('MouseEvents');
            event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
        }
        aLink.dispatchEvent(event);

    }

    /**
	 * 通用的打开下载对话框方法，没有测试过具体兼容性
	 * @param url 下载地址，也可以是一个blob对象，必选
	 * @param saveName 保存文件名，可选
	 */
	function openDownloadDialog(url, saveName)
	{
		if(typeof url == 'object' && url instanceof Blob)
		{
			url = URL.createObjectURL(url); // 创建blob地址
		}
		var aLink = document.createElement('a');
		aLink.href = url;
		aLink.download = saveName || ''; // HTML5新增的属性，指定保存文件名，可以不要后缀，注意，file:///模式下不会生效
		var event;
		if(window.MouseEvent) event = new MouseEvent('click');
		else
		{
			event = document.createEvent('MouseEvents');
			event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
		}
		aLink.dispatchEvent(event);
	}

    // table转化为csv
    function table2csv(table) {
		var csv = [];
		$(table).find('tr').each(function() {
			var temp = [];	
			$(this).find('td').each(function() {
				temp.push($(this).html());
			})
			temp.shift(); // 移除第一个
			csv.push(temp.join(','));
		});
		csv.shift();
		return csv.join('\n');
	}
    // 将csv转换成表格
	function csv2table(csv)
	{
		var html = '<table>';
		var rows = csv.split('\n');
		rows.pop(); // 最后一行没用的
		rows.forEach(function(row, idx) {
			var columns = row.split(',');
			columns.unshift(idx+1); // 添加行索引
			if(idx == 0) { // 添加列索引
				html += '<tr>';
				for(var i=0; i<columns.length; i++) {
					html += '<th>' + (i==0?'':String.fromCharCode(65+i-1)) + '</th>';
				}
				html += '</tr>';
			}
			html += '<tr>';
			columns.forEach(function(column) {
				html += '<td>'+column+'</td>';
			});
			html += '</tr>';
		});
		html += '</table>';
		return html;
	}
    // csv转sheet对象
	function csv2sheet(csv) {
		var sheet = {}; // 将要生成的sheet
		csv = csv.split('\n');
		csv.forEach(function(row, i) {
			row = row.split(',');
			if(i == 0) sheet['!ref'] = 'A1:'+String.fromCharCode(65+row.length-1)+(csv.length-1);
			row.forEach(function(col, j) {
				sheet[String.fromCharCode(65+j)+(i+1)] = {v: col};
			});
		});
		return sheet;
	}
    function removeEmptyArrayEle(arr){    
        for(var i = 0; i < arr.length; i++) {
        if(arr[i] == '') {
            arr.splice(i,1);
            i = i - 1; // i - 1 ,因为空元素在数组下标 2 位置，删除空之后，后面的元素要向前补位，
                            // 这样才能真正去掉空元素,觉得这句可以删掉的连续为空试试，然后思考其中逻辑
            }
        }
        return arr;
    };

    function csv2JSON(csv){

        var lines=csv.split("\n");
        var result = [];
        var headers=removeEmptyArrayEle(lines[0].split(","));

        for(var i=1;i<lines.length;i++){

            var obj = {};
            var currentline=removeEmptyArrayEle(lines[i].split(","));

            for(var j=0;j<headers.length;j++){
                obj[headers[j]] = currentline[j];
            }

            result.push(obj);

        }

        //return result; //JavaScript object
        return JSON.stringify(result); //JSON
    }

    // 毫秒转换为时、分、秒
    function  formateMilisecond(milliseconds){
        var hours = parseInt((milliseconds % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var mins = parseInt((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = (milliseconds % (1000 * 60)) / 1000;
        var returnStr ='';
        hours > 0 ? returnStr += hours + "小时" : null;
        mins > 0 ? returnStr += mins + "分钟" : null;
        seconds > 0 ? returnStr += seconds + "秒" : null;
        return returnStr;



    }



</script>
</body>
</html> 